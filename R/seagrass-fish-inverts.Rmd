---
title: "Seagrass Fish and Inverts"
author: "ZL Monteith & F Manning"
date: '2020-07-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Seagrass Fish and Inverts Data Package

## Purpose
This script serves to collect, aggregate, and QC fish and macroinvertebrate
survey data from the Hakai Nearshore Seagrass project.

***

## Setup

Clear work space prior to starting
```{r}
rm(list = ls())
```

Load necessary packages
```{r}
lapply(c("tidyverse",
         "lubridate", 
         "magrittr",
         "DataCombine"),
       library,
       character.only = TRUE)
```

Load data
```{r}
fish <- read.csv("../raw-data/seagrass_fish.csv")
inverts <- read.csv("../raw-data/seagrass_inverts.csv")
events <- read.csv("../raw-data/seagrass_events.csv")
names <- read.csv("../raw-data/seagrass_names.csv")
```

Remove unneeded variables automatically added in portal
```{r}
events <- subset(events, select = -c(action, samples))
```


## Data Quality Check

### Cross Reference Events
In order to ensure completeness of the fish and invertebrate datasets (i.e. all
site visits are included), the data will be aggregated to the event level, and
then cross referenced with the events data also loaded from the EIMS Portal. If
all data are present, the fish and invertebrate events should match the Events
table.

For each event (i.e.. transect - site_id - level visit), there should be two
fish surveys, and two invertebrate surveys. 

```{r event-qc}
# aggregate fish to event level
fish_events <-
  fish %>%
  group_by(date, survey, site_id, collector, collected_start) %>%
  summarise(n_species_obs = n()) %>%
  ungroup() %>%
  group_by(date, survey, site_id) %>%
  summarise(n_fish_surveys = n())

# aggregate inverts to event level
inverts_events <-
  inverts %>%
  group_by(date, survey, site_id, collector, collected_start) %>%
  summarise(n_species_obs = n()) %>%
  ungroup() %>%
  group_by(date, survey, site_id) %>%
  summarise(n_inverts_surveys = n())

# clean and aggregate events
events_count <-
  events %>%
  group_by(date, survey, site_id) %>%
  summarise(n_events = n())  # 

# join fish events with events; there should be two fish surveys for each event
fish_events_check <-
  right_join(fish_events, events_count) %>%
   # remove typo Koeye events still stuck in data portal
  filter(!grepl("KOEYE_ESTUARY_ESTUARY", survey),
         !grepl("KOEYE_ESTUARY ESTUARY", survey),
         !grepl("^KOEYE_KOEYE.*", site_id))

# join invert events with events; there should be two invert surveys for each event
inverts_events_check <-
  right_join(inverts_events, events_count) %>%
   # remove typo Koeye events still stuck in data portal
  filter(!grepl("KOEYE_ESTUARY_ESTUARY", survey),
         !grepl("KOEYE_ESTUARY ESTUARY", survey),
         !grepl("^KOEYE_KOEYE.*", site_id))

# subset out events without the appropriate number of fish surveys
## all data missing (both surveys)
fish_2surveys_missing <-
  fish_events_check %>%
  filter(is.na(n_fish_surveys))

## one survey missing
fish_1survey_missing <-
  fish_events_check %>%
  filter(n_fish_surveys == 1)

## too many surveys; possibly entered twice, or mislabeled
fish_too_many_surveys <-
  fish_events_check %>%
  filter(n_fish_surveys > 2)

## join all fish events needing QC
fish_events_to_QC <-
  rbind(fish_2surveys_missing,
        fish_1survey_missing,
        fish_too_many_surveys) %>%
  mutate(issue = case_when(is.na(n_fish_surveys) ~ "both surveys missing",
                           n_fish_surveys == 1 ~ "one survey missing",
                           n_fish_surveys > 2 ~ "too many surveys")) %>%
  
## 2015 data not in the data portal currently
  filter(year(date) != 2015) %>%
  
## For 2018 onward, no fish and invert surveys conducted for Goose SE, McMullin, and Triquet
  filter(!(year(date) >= 2018 & survey == "GOOSE_SOUTHEAST"), 
           !(year(date) >= 2018 & survey == "MCMULLIN_NORTH"), 
             !(year(date) >= 2018 & survey == "MCMULLIN_SOUTH"), 
               !(year(date) >= 2018 & survey =="TRIQUET_NORTH"), 
                 !(year(date) >= 2018 & survey =="TRIQUET_BAY"))

## save `fish_events_to_QC` to .csv:
write.csv(fish_events_to_QC, "../raw-data/fish_events_to_QC.csv")

# subset out events without the appropriate number of invert surveys
## all data missing (both surveys)
inverts_2surveys_missing <-
  inverts_events_check %>%
  filter(is.na(n_inverts_surveys))

## one survey missing
inverts_1survey_missing <-
  inverts_events_check %>%
  filter(n_inverts_surveys == 1)

## too many surveys; possibly entered twice, or mislabeled
inverts_too_many_surveys <-
  inverts_events_check %>%
  filter(n_inverts_surveys > 2)

## join all invert events needing QC
inverts_events_to_QC <-
  rbind(inverts_2surveys_missing,
        inverts_1survey_missing,
        inverts_too_many_surveys) %>%
  mutate(issue = case_when(is.na(n_inverts_surveys) ~ "both surveys missing",
                           n_inverts_surveys == 1 ~ "one survey missing",
                           n_inverts_surveys > 2 ~ "too many surveys")) %>%
  
## 2015 data not in the data portal currently
  filter(year(date) != 2015) %>%

## For 2018 onward, no fish and invert surveys conducted for Goose SE, McMullin, and Triquet
  filter(!(year(date) >= 2018 & survey == "GOOSE_SOUTHEAST"), 
           !(year(date) >= 2018 & survey == "MCMULLIN_NORTH"), 
             !(year(date) >= 2018 & survey == "MCMULLIN_SOUTH"), 
               !(year(date) >= 2018 & survey =="TRIQUET_NORTH"), 
                 !(year(date) >= 2018 & survey =="TRIQUET_BAY"))

## save `inverts_events_to_QC` to .csv:
write.csv(inverts_events_to_QC, "../raw-data/inverts_events_to_QC.csv")
```


### Fixing names

Fix species names so there aren't multiple names for single species
```{r}
# import list of acceptable fish names
fishnames_accepted <- names$fish %>% data.frame
colnames(fishnames_accepted) <- "name"

# create list of fish names in data that need fixing
fishnames_data <- unique(fish$species) %>% sort %>% data.frame
colnames(fishnames_data) <- "name"
fishnames_tofix <- anti_join(fishnames_data, fishnames_accepted)
fishnames_tofix <- filter(fishnames_tofix, name != "no_obs")

# add corresponding acceptable fish names to replace ones that need fixing
fishnames_tofix$replace <- c("flounder/arrow_tooth", "goby/bay", "pipefish/bay", "skate/big", "sole/c-o", "rockfish/deacon", "sole/english", "sole/english", "flatfish/soledab", "sole/c-o", "flatfish/soledab", "goby/bay", "goby/blackeye", "greenling/white-spotted", "greenling/white-spotted", "flounder/pacific_sanddab", "flounder/pacific_sanddab", "greenling/painted", "flounder/pacific_sanddab", "prickleback/snake", "sole/rock", "rockfish/deacon", "rockfish/deacon", "rockfish/black-yellowtail_complex", "rockfish/bocaccio", "sole/sand", "flounder/pacific_sanddab", "skate/unknown", "sole/unknown", "sole/english", "sole/unknown", "flatfish/soledab", "threespine_stickleback", "threespine_stickleback", "threespine_stickleback", "threespine_stickleback", "threespine_stickleback", "cod/unknown", "flatfish/unknown", "flatfish/unknown", "rockfish/vermillion", "greenling/white-spotted", "greenling/white-spotted") 

fish <- FindReplace(fish, "species", fishnames_tofix, from = "name", to = "replace", exact = TRUE, vector = FALSE)

# FindReplace had trouble with replacing the one name containing parentheses, fix that here
fish$species[fish$species == "three spine stickleback (thst)"] <- "threespine_stickleback"
```

Repeat for inverts names
```{r}
# import list of acceptable inverts names
invertsnames_accepted <- names$inverts %>% data.frame
colnames(invertsnames_accepted) <- "name"

# fix misspelling
inverts$species <- gsub("melabie", "melibe", inverts$species)

# create list of fish names in data that need fixing
invertsnames_data <- unique(inverts$species) %>% sort %>% data.frame
colnames(invertsnames_data) <- "name"
invertsnames_tofix <- anti_join(invertsnames_data, invertsnames_accepted)
invertsnames_tofix <- filter(invertsnames_tofix, name != "no_obs")

# add corresponding acceptable fish names to replace ones that need fixing
invertsnames_tofix$replace <- c("painted/anemone", "snail/pomaulax", "chiton/unknown", "chiton/unknown", "chiton/unknown", "siphon/cockle", "crab/cancer", "crab/dungeness", "crab/hermit", "crab/northern_kelp", "crab/pugettia", "crab/red_rock", "crab/unknown", "crab/pugettia", "chiton/gumboot", "seacucumber/other", "nudibranch/dendronotus", "seastar/dermasterias", "snail/dire_whelk","seastar/evasterias", "seastar/evasterias", "chiton/gumboot", "isopod/idotea", "seastar/leptasterias", "seastar/evasterias", "snail/other", "nudibranch/melibe", "nudibranch/unknown","nudibranch/other", "crab/hermit", "crab/hermit", "seastar/pisaster_ochraceus", "snail/pomaulax", "snail/pomaulax", "snail/pomaulax", "crab/pugettia", "snail/purple_olive", "snail/purple_olive", "clam/purple_velvet", "urchin/sand_dollar", "seacucumber/other", "seastar/dermasterias", "seapen/orange", "seastar/dermasterias", "seastar/pycnopodia", "seastar/dermasterias", "worm/other", "shrimp/pandalus", "siphon/geoduck", "siphon/horse_clam", "siphon/unknown", "nudibranch/other", "snail/pomaulax", "snail/tegula", "snail/unknown", "snail/dire_whelk", "seacucumber/other") 

inverts <- FindReplace(inverts, "species", invertsnames_tofix, from = "name", to = "replace", exact = TRUE, vector = FALSE)
```

We seem to have the same naming issue for some other variables; let's fix this for the "collector" (i.e. diver) variable in both the fish and inverts data frames since we'll be using those later
```{r}
# import list of acceptable collector names
diversnames_accepted <- names$divers %>% data.frame
colnames(diversnames_accepted) <- "name"

# fix collector names in fish 
fish_diversnames_data <- unique(fish$collector) %>% sort %>% data.frame
colnames(fish_diversnames_data) <- "name"
fish_diversnames_tofix <- anti_join(fish_diversnames_data, diversnames_accepted)
fish_diversnames_tofix$replace <- c("andrew", "derek", "derek", "kyle", "ondine", "other", "zach", "zach") 
fish <- FindReplace(fish, "collector", fish_diversnames_tofix, from = "name", to = "replace", exact = TRUE, vector = FALSE)

# fix collector names in inverts
inverts_diversnames_data <- unique(inverts$collector) %>% sort %>% data.frame
colnames(inverts_diversnames_data) <- "name"
inverts_diversnames_tofix <- anti_join(inverts_diversnames_data, diversnames_accepted)
inverts_diversnames_tofix$replace <- c("kyle", "other", "zach") 
inverts <- FindReplace(inverts, "collector", inverts_diversnames_tofix, from = "name", to = "replace", exact = TRUE, vector = FALSE)
```

And do the same for dive tenders while we're at it
```{r}
# import list of acceptable tender names
techsnames_accepted <- names$techs %>% data.frame
colnames(techsnames_accepted) <- "name"

# fix tender names in fish
fish_techsnames_data <- unique(fish$dive_supervisor) %>% sort %>% data.frame
colnames(fish_techsnames_data) <- "name"
fish_techsnames_tofix <- anti_join(fish_techsnames_data, techsnames_accepted)
fish_techsnames_tofix$replace <- c("angeleen", "angeleen,carolyn", "angeleen,carolyn,zach", "angeleen,zach", "angeleen,carolyn,krystal", "derek", "derek,kyle", "gillian", "gillian", "zach")
fish <- FindReplace(fish, "dive_supervisor", fish_diversnames_tofix, from = "name", to = "replace", exact = TRUE, vector = FALSE)

# fix tender names in inverts
inverts_techsnames_data <- unique(inverts$dive_supervisor) %>% sort %>% data.frame
colnames(inverts_techsnames_data) <- "name"
inverts_techsnames_tofix <- anti_join(inverts_techsnames_data, techsnames_accepted)
inverts_techsnames_tofix$replace <- c("angeleen", "angeleen,carolyn,krystal", "derek", "gillian", "gillian")
inverts <- FindReplace(inverts, "dive_supervisor", inverts_techsnames_tofix, from = "name", to = "replace", exact = TRUE, vector = FALSE)
```

Also, all siphons should have size_cm as NA, so fix that here:
```{r}
inverts$size_cm <- replace(inverts$size_cm, grepl("siphon", inverts$species), NA)
```


### Checking for suspicious values - fish

Check fish lengths for suspicious values, using Q-Q plots to look at data values vs. quantiles:
```{r}
# create qqplot for lengths
fishlengths_qqplot <- fish %>%
  ggplot(aes(col = species)) + 
  stat_qq(aes(sample = length_cm)) + 
  stat_qq_line(aes(sample = length_cm)) + 
  facet_wrap( ~ species) + 
  theme_classic() + 
  theme(legend.position = "none")
fishlengths_qqplot
```



Looks like there might some fishy-looking fish lengths so let's do some flagging
```{r}
# create working fish length data frame with just relevant data, including mean and sd
fishlengths <- fish %>%
  filter(!is.na(quantity)) %>%
  uncount(quantity) %>%
  select(X, species, length_cm) %>%
  left_join(fish %>% 
  group_by(species) %>% 
  summarise(mean = mean(length_cm, na.rm = T),
            sd = sd(length_cm, na.rm = T))) %>%
  unique()

# make qc flag bounds
fishlengths$upper99 <- fishlengths$mean + 2.5*fishlengths$sd
fishlengths$lower99 <- fishlengths$mean - 2.5*fishlengths$sd
fishlengths$upper95 <- fishlengths$mean + 2*fishlengths$sd
fishlengths$lower95 <- fishlengths$mean - 2*fishlengths$sd

# assign qc flags
fishlengths$qc_flag_lengths <- ifelse(fishlengths$length_cm < fishlengths$lower99, "SVD",
                                     ifelse(fishlengths$length_cm < fishlengths$lower95, "SVC",
                                             ifelse(fishlengths$length_cm < fishlengths$upper95, "AV",
                                                     ifelse(fishlengths$length_cm < fishlengths$upper99, "SVC", "SVD"))))

# merge QC flags back into OG fish data frame
fish <- left_join(fish, (select(fishlengths, "X", "qc_flag_lengths")), on = "X")
```

Check fish abundances for suspicious values:
```{r}
# note that for abundance, we'll want to group quantity by species and transect (unique combos of site_id, date, and collector) to look at average quantity per transect

# create new variable for transect, merging site_id, date, and collector together
fish$transect <- paste(fish$site_id, fish$date, fish$collector, sep = "_")

# create working fish length data frame with just relevant data, including mean and sd
fishabunds <- fish %>%
  filter(!is.na(quantity)) %>%
  select(X, transect, species, quantity) %>%
  left_join(fish %>% 
  group_by(transect, species) %>% 
  summarise(mean = mean(quantity, na.rm = T),
            sd = sd(quantity, na.rm = T)))

# make qc flags bounds
fishabunds$upper99 <- fishabunds$mean + 2.5*fishabunds$sd
fishabunds$lower99 <- fishabunds$mean - 2.5*fishabunds$sd
fishabunds$upper95 <- fishabunds$mean + 2*fishabunds$sd
fishabunds$lower95 <- fishabunds$mean - 2*fishabunds$sd

# assign qc flags
fishabunds$qc_flag_abunds <- ifelse(fishabunds$quantity < fishabunds$lower99, "SVD",
                                     ifelse(fishabunds$quantity < fishabunds$lower95, "SVC",
                                             ifelse(fishabunds$quantity < fishabunds$upper95, "AV",
                                                     ifelse(fishabunds$quantity < fishabunds$upper99, "SVC", "SVD"))))

# merge QC flags back into OG fish data frame and remove transects column 
fish <- left_join(fish, (select(fishabunds, "X", "qc_flag_abunds")), on = "X")
fish <- subset(fish, select = -(transect))
```

### Checking for suspicious values - inverts

Check inverts sizes for suspicious values, using Q-Q plots to look at data values vs. quantiles:
```{r}
# create qqplot for lengths
invertssize_qqplot <- inverts %>%
  ggplot(aes(col = species)) + 
  stat_qq(aes(sample = size_cm)) + 
  stat_qq_line(aes(sample = size_cm)) + 
  facet_wrap( ~ species) + 
  theme_classic() + 
  theme(legend.position = "none")
invertssize_qqplot
```

Looks great overall but let's still do some flagging using mean+sd method
```{r}
# create working inverts size data frame with just relevant data, including mean and sd
invertssizes <- inverts %>%
  filter(!is.na(quantity)) %>%
  uncount(quantity) %>%
  select(X, species, size_cm) %>%
  left_join(inverts %>% 
  group_by(species) %>% 
  summarise(mean = mean(size_cm, na.rm = T),
            sd = sd(size_cm, na.rm = T))) %>%
  unique()

# make qc flags bounds
invertssizes$upper99 <- invertssizes$mean + 2.5*invertssizes$sd
invertssizes$lower99 <- invertssizes$mean - 2.5*invertssizes$sd
invertssizes$upper95 <- invertssizes$mean + 2*invertssizes$sd
invertssizes$lower95 <- invertssizes$mean - 2*invertssizes$sd

# add qc flags
invertssizes$qc_flag_sizes <- ifelse(invertssizes$size_cm < invertssizes$lower99, "SVD",
                                     ifelse(invertssizes$size_cm < invertssizes$lower95, "SVC",
                                             ifelse(invertssizes$size_cm < invertssizes$upper95, "AV",
                                                     ifelse(invertssizes$size_cm < invertssizes$upper99, "SVC", "SVD"))))

# merge QC flags back into OG inverts data frame
inverts <- left_join(inverts, (select(invertssizes, "X", "qc_flag_sizes")), on = "X")
```

Check inverts abundances for suspicious values:
```{r}
# note that for abundance, we'll want to group quantity by species and transect (unique combos of site_id, date, and collector) to look at average quantity per transect

# create new variable for transect, merging site_id, date, and collector together
inverts$transect <- paste(inverts$site_id, inverts$date, inverts$collector, sep = "_")

# create working fish length data frame with just relevant data, including mean and sd
invertsabunds <- inverts %>%
  filter(!is.na(quantity)) %>%
  select(X, transect, species, quantity) %>%
  left_join(inverts %>% 
  group_by(transect, species) %>% 
  summarise(mean = mean(size_cm, na.rm = T),
            sd = sd(size_cm, na.rm = T)))

# make qc flags bounds
invertsabunds$upper99 <- invertsabunds$mean + 2.5*invertsabunds$sd
invertsabunds$lower99 <- invertsabunds$mean - 2.5*invertsabunds$sd
invertsabunds$upper95 <- invertsabunds$mean + 2*invertsabunds$sd
invertsabunds$lower95 <- invertsabunds$mean - 2*invertsabunds$sd

# add qc flags
invertsabunds$qc_flag_abunds <- ifelse(invertsabunds$quantity < invertsabunds$lower99, "SVD",
                                     ifelse(invertsabunds$quantity < invertsabunds$lower95, "SVC",
                                             ifelse(invertsabunds$quantity < invertsabunds$upper95, "AV",
                                                     ifelse(invertsabunds$quantity < invertsabunds$upper99, "SVC", "SVD"))))

# merge QC flags back into OG inverts data frame and remove transects column 
inverts <- left_join(inverts, (select(invertsabunds, "X", "qc_flag_abunds")), on = "X")
inverts <- subset(inverts, select = -(transect))
```